"use strict";var Q=(function(){var win=this,useSetTimeout=(win.navigator.userAgent.indexOf("Chrome")>-1),doc=win.document,requests=[],running=false,DOMloaded=false,setDOMloaded=function(bool){return(DOMloaded=bool)},getRequests=function(){return requests},push=function(r){requests.push(r);return this},shift=function(){requests.shift().execute();return this},clear=function(){requests=[];return this},getRunning=function(){return running},setRunning=function(bool){return(running=bool)},event=function(type,context){var e=doc.createEvent("UIEvents");e.initEvent(type,false,false);e.requestor=context||null;doc.dispatchEvent(e);return context},mixin=function(){var args=Array.prototype.slice.apply(arguments),r=args.shift(),o,m;while(args.length){m=args.shift();for(o in m){if(m.hasOwnProperty(o)){r[o]=m[o]}}}return r},start=function(){if(DOMloaded&&!running){running=true;event("Q.request.execute")}else{win.addEventListener("DOMContentLoaded",function(){Q.start()},false)}return this},stop=function(){running=false;return this},length=function(){return requests.length};setDOMloaded((doc.readyState==="complete"));win.addEventListener("DOMContentLoaded",function(){Q.setDOMloaded(true)},false);doc.addEventListener("Q.request",function(e){Q.push(e.requestor)},false);doc.addEventListener("Q.request.execute",function(e){if(Q.length()>0&&Q.isRunning()){if(useSetTimeout){setTimeout(Q.shift,0)}else{Q.shift()}}else{Q.setRunning(false)}},false);return{push:push,clear:clear,doc:doc,event:event,mixin:mixin,isRunning:getRunning,length:length,start:start,requests:getRequests,setDOMloaded:setDOMloaded,setRunning:setRunning,shift:shift,stop:stop,win:win}}());Q.Class=function(options){if(!(this instanceof Q.Class)){return new Q.Class(options)}this.name="Q.Class";this.config=options;this.request()};Q.Class.prototype.configure=function(){var that=this,expand=function(c,obj){var o;for(o in obj){if(obj.hasOwnProperty(o)){switch(typeof obj[o]){case"object":if(obj[o].nodeType||obj[o].config){c[o]=obj[o]}else{if(obj[o].constructor.name==="Array"){c[o]=expand([],obj[o])}else{c[o]=expand({},obj[o])}}break;case"function":if(o==="fn"){c[o]=obj[o]}else{c[o]=obj[o].apply(that)}break;default:c[o]=obj[o];break}}}return c};return expand({},this.config)};Q.Class.prototype.request=function(){Q.event("Q.request",this);return this};Q.Class.prototype.start=function(){Q.start()};Q.Class.prototype.fire=function(){this.request().start()};Q.Class.prototype.clone=function(options){return new this.constructor(Q.mixin({},this.config,options))};Q.Class.prototype.execute=function(){Q.event("Q.request.execute")};Q.Class.prototype.subClass=function(name,defaults){var parent=this,ns=name.split(".").slice(1),n=Q;while(ns.length>1){n=n[ns.shift()]}n[ns[0]]=function(options){if(!(this instanceof n[ns[0]])){return new n[ns[0]](options)}this.config=Q.mixin({},parent.config,defaults,options);this.__super__=parent;this.name=name;this.request()};Q.mixin(n[ns[0]].prototype,parent.constructor.prototype)};Q.Class.prototype.singleton=function(name,defaults){var parent=this,ns=name.split(".").slice(1),n=Q;while(ns.length>1){n=n[ns.shift()]}n[ns[0]]=function(options){var that,instance=this.constructor.instance;if((this instanceof n[ns[0]])&&instance){return instance}if(!(this instanceof n[ns[0]])){return new n[ns[0]](options)}that=this;this.__super__=parent;this.name=name;this.config=Q.mixin({},parent.config,defaults,options);this.constructor.instance=that};Q.mixin(n[ns[0]].prototype,parent.constructor.prototype)};Q.Class.prototype.multiton=function(name,defaults){var parent=this,ns=name.split(".").slice(1),n=Q;while(ns.length>1){n=n[ns.shift()]}n[ns[0]]=function(options){var that;if(!(this instanceof n[ns[0]])){return new n[ns[0]](options)}that=this;this.__super__=parent;this.name=name;this.config=Q.mixin({},parent.config,defaults,options);if(!this.constructor.instance){this.constructor.instance=[]}this.constructor.instance.push(that);this.request()};Q.mixin(n[ns[0]].prototype,parent.constructor.prototype)};Q.Class.prototype.singleton.apply({},["Q.Db",{shortName:"Q",version:"1.0",displayName:"Q Database",maxSize:5*1024*1024}]);Q.Db.prototype.connect=function(){var db=Q.Db(),c=db.config;if(db.connection===undefined){db.connection=Q.win.openDatabase(c.shortName,c.version,c.displayName,c.maxsize)}return db.connection};Q.Class().subClass("Q.Sql");Q.Sql.prototype.dataHandler=function(){var that=this;return function(transaction,results){var makeArray=function(results){var r=results.rows||results,i=r.length,arr=[];while(i){i-=1;arr[i]=r.item?r.item(i):r[i]}return arr};that.results=makeArray(results);that.__super__.execute()}};Q.Sql.prototype.bulkErrorHandler=function(){var that=this;return function(transaction,error){console.error("Q.Sql",that,"Message:",error.message,"Code:",error.code);return false}};Q.Sql.prototype.errorHandler=function(){var that=this;return function(transaction,error){that.bulkErrorHandler().apply(that,[transaction,error]);that.__super__.execute();return false}};Q.Sql.prototype.execute=function(){var config=this.configure(),stmt=config.stmt||"",args=config.args?config.args.slice():[],callback=this.dataHandler(),bulkErrorHandler=this.bulkErrorHandler(),errorHandler=this.errorHandler(),placeHolders=stmt.match(/\{(\w|:)+?\}/g)||[];placeHolders.forEach(function(ph){var rx=new RegExp(ph),val=config,name=ph.substring(1,ph.length-1);name=name.split(":");while(name.length){val=val[name.shift()]}stmt=stmt.replace(rx,val)});if(stmt.length){Q.Db().connect().transaction(function(t){if(typeof args[0]==="object"){while(args.length>1){t.executeSql(stmt,args.shift(),{},bulkErrorHandler)}t.executeSql(stmt,args.shift(),callback,errorHandler)}else{t.executeSql(stmt,args,callback,errorHandler)}})}else{this.__super__.execute.apply(this)}};Q.Class().subClass("Q.Js",{fn:function(){}});Q.Js.prototype.execute=function(){var c=this.configure();this.results=c.fn.apply(this,c.args);this.__super__.execute()};Q.Class().subClass("Q.Storage",{action:"",expects:"",store:{}});Q.Storage.prototype.execute=function(){var c=this.config,r,str,s=c.store;if(typeof c.value==="function"){c.value=c.value.call()}switch(c.action){case"setItem":switch(typeof c.value){case"string":str=c.value;break;case"boolean":str=(c.value)?"b:true":"b:false";break;case"object":str="j:"+JSON.stringify(c.value);break;case"number":str="n:"+c.value;break}s[c.key]=str;r=c.value;break;case"getItem":r=s[c.key]||c.expects;switch(r.substring(0,2)){case"j:":r=JSON.parse(r.slice(2));break;case"b:":r=(r==="b:true");break;case"n:":if(r.indexOf(".")>=0){r=parseFloat(r.slice(2))}else{r=parseInt(r.slice(2),10)}break}break;case"clear":s.clear();r=undefined;break;case"removeItem":r=delete s[c.key];break;case"key":r=s[c.key]||this.expects;break;case"length":r=s.length;break;default:}this.results=r;this.__super__.execute()};Q.Class().subClass("Q.Ajax",{type:"GET",contentType:"application/x-www-form-urlencoded",accepts:"*/*",cache:false,dataType:"json"});Q.Ajax.prototype.dataHandler=function(){var that=this;return function(){if(this.readyState===4){if(this.status===200){that.status="success";switch(that.config.dataType){case"json":that.results=JSON.parse(this.responseText);break;case"xml":that.results=this.responseXML;break;default:that.results=this.responseText}}else{that.status="failure";console.warn("Q.Ajax failure",this)}that.__super__.execute()}}};Q.Ajax.prototype.execute=function(){var c=this.configure(),url=c.url,user=c.user||"",password=c.password||"",randomString=function(i){var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",str="";while(i){i-=1;str+=chars.charAt(Math.floor(Math.random()*chars.length))}return str};if(!c.cache){if(url.indexOf("?")!==-1){url+="&_="}else{url+="?_="}url+=randomString(8)}this.xhr=new Q.win.XMLHttpRequest();this.xhr.open(c.type,url,true,user,password);this.xhr.setRequestHeader("Content-Type",c.contentType);this.xhr.setRequestHeader("Accept",c.accepts);this.xhr.onreadystatechange=this.dataHandler();try{this.xhr.send()}catch(e){this.result=e;console.error("Q.Ajax error",this)}};Q.Class().subClass("Q.Dom");Q.Dom.prototype.execute=function(){var c=this.configure(),doc=Q.doc,o,elm;if(c.tagName){elm=doc.createElement(c.tagName)}if(elm&&c.attribute){for(o in c.attribute){if(c.attribute.hasOwnProperty(o)){elm[o]=c.attribute[o]}}}if(elm&&c.event){for(o in c.event){if(c.event.hasOwnProperty(o)){elm[o]=c.event[o].fn.apply(this)}}}if(c.parent&&elm){c.parent.appendChild(elm)}if(!c.event){this.__super__.execute()}};Q.Dom().subClass("Q.Dom.Script",{parent:function(){return Q.doc.getElementsByTagName("HEAD")[0]},tagName:"SCRIPT",event:{onload:{fn:function(){return this.scriptHandler()}}}});Q.Dom.Script.prototype.scriptHandler=function(){var that=this;return function(e){e.target.parentNode.removeChild(e.target);that.status="success";that.__super__.execute()}};Q.Class().subClass("Q.Worker");Q.Worker.prototype.dataHandler=function(context,config){return function(e){var wait=config.wait||1;context.results.push(JSON.parse(e.data));if(context.results.length===wait){context.__super__.execute()}}};Q.Worker.prototype.execute=function(){var c=this.configure();this.worker=new Worker(c.url);this.results=[];this.worker.onmessage=this.dataHandler(this,c);this.worker.postMessage(c.message)};Q.Class().multiton("Q.Test");Q.Test.prototype.execute=function(){var r,that=this,c=that.configure();if(c.test.constructor.name==="Array"){that.results=[];c.test.some(function(e){r=e.fn();that.results.push(r);if(r===e.expects){that.status="passed";return false}else{that.status="failed";return true}})}else{r=c.test.fn();that.results=r;that.status=(r===c.test.expects)?"passed":"failed"}if(that.status==="failed"){console.warn("Q.Test failed",that)}this.__super__.execute()};Q.Sql().subClass("Q.Sql.Read",{stmt:"SELECT * FROM {tableName};"});Q.Sql().subClass("Q.Sql.Drop",{stmt:"DROP TABLE IF EXISTS {tableName};"});Q.Storage().subClass("Q.Storage.Local",{store:localStorage});if(Q.win.navigator.userAgent.indexOf("Firefox")>-1&&Q.win.location.href.indexOf("file:///")===0){}else{Q.Storage().subClass("Q.Storage.Session",{store:sessionStorage})};